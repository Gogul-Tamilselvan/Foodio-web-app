<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Foodio</title>
  <link rel="icon" type="image/x-icon" href="../images/webicon.png">
  <!-- bootstrap cdn -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
  <!-- Fast Bootstrap cdn -->
  <link href="https://cdn.jsdelivr.net/npm/fastbootstrap@2.2.0/dist/css/fastbootstrap.min.css" rel="stylesheet"
    integrity="sha256-V6lu+OdYNKTKTsVFBuQsyIlDiRWiOmtC8VQ8Lzdm2i4=" crossorigin="anonymous" />

  <!-- font awesome cdn -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- aos cdn -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />

  <link rel="stylesheet" href="../Css/signup.css" />
  <link rel="stylesheet" href="../Css/main.css">
  <link rel="stylesheet" href="../Css/loader.css">
</head>

<body>

 
  <!-- preloader starts -->
  <div  id="headerloader" class="headerloader" >
    <div class="loader"></div>
  </div>

  <!-- nav bar start -->


  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarButtonsExample"
        aria-expanded="false">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand mt-2" href="#">
        <img src="../images/foodio.png" alt="" width="140" height="50"
      </a>
      <div class="collapse navbar-collapse" id="navbarButtonsExample">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="../index.html#home">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="./cart.html">View cart <span
                class="badge text-bg-danger">New</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="./Profile.html">View your profile</a>
          </li>
        </ul>
        <div class="d-flex align-items-center ms-auto mb-2 mt-2">
          <button type="button" id="loginbtn" class="btn px-3 me-2 loginbtn">
            <i class="fa-solid fa-user"></i> Login
          </button>
          <a class="btn btn-subtle px-3 github" href="https://github.com/mdbootstrap/mdb-ui-kit" role="button"><i
              class="fa-brands fa-github"></i></a>
        </div>
      </div>
    </div>
  </nav>
  <!-- nav bar end -->
  <!-- 
    search button -->

  <div class="container">
    <div class="row d-flex justify-content-center mt-5 ">
      <h1 class=" mt-5 text-center">Foodio</h1>
      <p class="text-center">Explore your Favourite Foods</p>
      <div class="col-12 col-lg-6 col-md-6 col-sm-12 search-back py-10 px-10 mx-10">
        <div class="input-group   ">
          <input type="text" class="form-control search-input" id="search-input"
            placeholder="Search for your Category...?" aria-label="Recipient's username"
            aria-describedby="button-addon2">
          <button class="btn search-btn" type="button" id="searchbtn">Search <i
              class="fa-solid fa-magnifying-glass"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- search button end -->

  <!-- food page -->
  <!-- 

search results -->
  <div class="container grid" id="searchresults">
    <!-- <div id="cards">
  <img id="card-img" src="${res.strMealThumb}" alt="">
  <div id="text">
  <h6 id="card-title" class="pt-1 text-center">${res.strMeal}</h6>
  </div>
  </div> -->
  </div>




  <h1 class="text-center my-10">CATEGORIES</h1>
  <div class="container grid" id="grid">
    <!-- <div id="cards"> -->
    <!-- <img  src="../images/food.png" alt="">
      <div id="text">
        <h6 id="card-title" class="pt-1 text-center">Seamlessly</h6>
          <p id="card-price" class="text-center fw-bold " style="color: rgb(255, 0, 0);" >$ 2999</p> 
        <button ><a href="">Add to Cart</a></button>
      </div> -->
    <!-- </div> -->
  </div>

  <h1 class="text-center mt-10">TRENDING FOODS</h1>
  <div class="container grid" id="trendingfood">
    <!-- <div id="cards"> -->
    <!-- <img  src="../images/food.png" alt="">
      <div id="text">
        <h6 id="card-title" class="pt-1 text-center">Seamlessly</h6>
          <p id="card-price" class="text-center fw-bold " style="color: rgb(255, 0, 0);" >$ 2999</p> 
        <button ><a href="">Add to Cart</a></button>
      </div> -->
    <!-- </div> -->
  </div>


  </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous">
    </script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    AOS.init();
  </script>
  <script type="module">
        window.addEventListener('load',()=>{document.getElementById('headerloader').style.display='none';})
    // let user_cred = JSON.parse(sessionStorage.getItem("user-cred"));
    // let user_info = JSON.parse(sessionStorage.getItem("user-info"));
    const loginbtn = document.getElementById('loginbtn')
    let checkcred = () => {
      if (!sessionStorage.getItem("user-creds")) {
        window.location.href = "./signin.html";
      }
      if (sessionStorage.getItem("user-creds")) {

        loginbtn.innerHTML = `<i class="fa-solid fa-right-from-bracket"></i> Logout`;

      }
    }
    window.addEventListener('load', checkcred)
    // logout function
    loginbtn.addEventListener('click', () => {
      sessionStorage.clear();
      signOut(auth)
        .then(async () => {
          let timerInterval;
          await Swal.fire({
            title: "Logging Out...",
            html: "Going to close in <b></b> milliseconds.",
            timer: 500,
            timerProgressBar: true,
            didOpen: () => {
              Swal.showLoading();
              const timer = Swal.getPopup().querySelector("b");
              timerInterval = setInterval(() => {
                timer.textContent = `${Swal.getTimerLeft()}`;
              }, 100);
            },
            willClose: () => {
              clearInterval(timerInterval);
            }
          })
          window.location.href = "./signin.html";
        })
        .catch((error) => {
          // An error happened.
          console.error("Error signing out: ", error);
        });
    })

    const rate = [150, 170, 190, 210, 350, 230, 250, 270, 290, 340, 370, 420, 460, 470, 490, 499, 599, 99, 699, 900, 645, 346]
    const latprice = rate[Math.floor(Math.random() * rate.length)];
    // let priceord = [];
    // for(let i=0;i<rate.length;i++){
    //   const latprice = rate[Math.floor(Math.random() * rate.length)];
    //   priceord.push(latprice)
    // }
    // console.log(priceord);


    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getDatabase,
      set,
      ref, update, push
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithPhoneNumber,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { default as firebaseConfig } from "../Js/firebase.js";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase();
    const auth = getAuth(app);



    const card_Price = document.getElementById("card-price");
    const container = document.getElementById("grid");
    const cardsdiv = document.getElementById("cards");
    const trendingfood = document.getElementById("trendingfood");
    const searchbtn = document.getElementById("searchbtn");
    const categoryURL = "https://www.themealdb.com/api/json/v1/1/categories.php";
    const randomURL = "https://www.themealdb.com/api/json/v1/1/random.php";
    const loader = document.getElementById('preloader');


    // preloader setting
    window.addEventListener('DOMContentLoaded', function () {
      loader.style.display = 'none';
    })


    // search filter
    const searchresults = document.getElementById('searchresults');
    searchbtn.addEventListener("click", search);
    let obj = [];
    async function search() {
      try {

        const searchinput = document.getElementById("search-input");
        const fetchurl = `https://www.themealdb.com/api/json/v1/1/filter.php?c=${searchinput.value}`;
        const fetching = await fetch(fetchurl);
        const response = await fetching.json();
        const result = await response.meals;
        obj.length = 0;
        obj.push(result);
        searchresults.innerHTML = '';
        // Process new data
        try {
          obj.forEach((res) => {
            res.forEach((meal) => {
              const condiv = document.createElement('a');
              // condiv.href="./"
              condiv.setAttribute('id', 'cards');
              const imgdiv = document.createElement("img");
              imgdiv.setAttribute('id', 'card-img');
              const textdiv = document.createElement("div");
              textdiv.setAttribute('id', 'text')
              const h6div = document.createElement("h6");
              h6div.setAttribute('id', 'card-title');
              h6div.style.textAlign = 'center';
              h6div.innerText = meal.strMeal.slice(0, 10);
              // const price =document.createElement('p')
              // price.setAttribute('id','price');
              // price.innerHTML="₹"+" "+rate[Math.floor(Math.random() * rate.length)];
              const btn = document.createElement('button');
              btn.innerText = 'Add to Cart';
              btn.value = meal.idMeal;
              // getting uid from session storage
              const session = sessionStorage.getItem("user-creds");
              const res = JSON.parse(session);
              const uid = res.uid;

              btn.onclick = (eve) => {
                const foodid = eve.target.attributes.value.textContent;
                console.log(foodid);
                push(ref(db, 'UsersRegisterList/' + uid + '/orderDetails/'), {
                  foodid,
                })
                push(ref(db, 'UsersRegisterList/' + uid + '/deliveried/'), {
                  foodid,
                })
                  .then(() => {
                    const Toast = Swal.mixin({
                      toast: true,
                      position: "top-end",
                      showConfirmButton: false,
                      timer: 1000,
                      timerProgressBar: true,
                      didOpen: (toast) => {
                        toast.onmouseenter = Swal.stopTimer;
                        toast.onmouseleave = Swal.resumeTimer;
                      }
                    });
                    Toast.fire({
                      icon: "success",
                      title: "Added to Cart"
                    });

                  })
                  .catch((err) => {
                    console.log(err.message);
                  })
              };

              imgdiv.src = meal.strMealThumb;
              textdiv.append(h6div, btn)
              condiv.append(imgdiv, textdiv);
              searchresults.appendChild(condiv);

            });
          });
        }
        catch (err) { console.log(err); }

      } catch (err) {
        console.log(err);
      }
    }

    // Categories fetching
    async function fetchCategories() {
      try {

        const fetching = await fetch(categoryURL);
        const response = await fetching.json();
        const result = response.categories;

        result.slice(0, 12).map((res) => {
          const imgdiv = document.createElement("img");
          imgdiv.setAttribute('id', 'card-img');
          const condiv = document.createElement('div');
          condiv.setAttribute('id', 'cards');
          condiv.dataset.myProperty = res.strCategory;
          condiv.onclick = async (eve) => {
            
            let obj = [];
            const searchinput = eve.target.parentNode.dataset.myProperty;
            try {
              const fetchurl = `https://www.themealdb.com/api/json/v1/1/filter.php?c=${searchinput}`;
              const fetching = await fetch(fetchurl);
              const response = await fetching.json();
              const result = await response.meals;
              obj.length = 0;
              obj.push(result);
              searchresults.innerHTML = '';
              // Process new data
              try {
                obj.forEach((res) => {
                  res.forEach((meal) => {
                    const condiv = document.createElement('a');
                    // condiv.href="./"
                    condiv.setAttribute('id', 'cards');
                    const imgdiv = document.createElement("img");
                    imgdiv.setAttribute('id', 'card-img');
                    const textdiv = document.createElement("div");
                    textdiv.setAttribute('id', 'text')
                    const h6div = document.createElement("h6");
                    h6div.setAttribute('id', 'card-title');
                    h6div.style.textAlign = 'center';
                    h6div.innerText = meal.strMeal.slice(0, 10);
                    const btn = document.createElement('button');
                    btn.innerText = 'Add to Cart';
                    btn.value = meal.idMeal;
                    // getting uid from session storage
                    const session = sessionStorage.getItem("user-creds");
                    const resp = JSON.parse(session);
                    const uid = resp.uid;

                    btn.onclick = (eve) => {
                    const foodid = eve.target.attributes.value.textContent;
                    push(ref(db, 'UsersRegisterList/' + uid + '/orderDetails/'), {
                      foodid,
                    });
                    push(ref(db, 'UsersRegisterList/' + uid + '/deliveried/'), {
                      foodid,
                    })
                        .then(() => {
                          
                          const Toast = Swal.mixin({
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 1000,
                            timerProgressBar: true,
                            didOpen: (toast) => {
                              toast.onmouseenter = Swal.stopTimer;
                              toast.onmouseleave = Swal.resumeTimer;
                            }
                          });
                          Toast.fire({
                            icon: "success",
                            title: "Added to Cart"
                          });

                        })
                        .catch((err) => {
                          console.log(err.message);
                        })
                    };
                    imgdiv.src = meal.strMealThumb;
                    textdiv.append(h6div, btn)
                    condiv.append(imgdiv, textdiv);
                    searchresults.appendChild(condiv);
                    

                  });
                });
              }
              catch (err) { 
                console.log(err.message); }

            } catch (err) {
              console.log(err);
            }

          }
          const textdiv = document.createElement("div");
          textdiv.setAttribute('id', 'text')
          const h6div = document.createElement("h6");
          h6div.setAttribute('id', 'card-title');
          h6div.style.textAlign = 'center';
          // const pdiv = document.createElement("p");
          // pdiv.setAttribute('class','text-center fw-bold');
          h6div.innerText = res.strCategory;
          const image = res.strCategory.toLowerCase();
          imgdiv.src = `https://www.themealdb.com/images/category/${image}.png`
          textdiv.append(h6div)
          condiv.append(imgdiv, textdiv);
          container.appendChild(condiv);

        })
      }
      catch (err) {
        console.log(err);
      }
    }
    fetchCategories();

    // Random food fetching

    async function trendingfoods() {
      const obj = [];
      try {

        for (let i = 0; i < 18; i++) {
          const fetching = await fetch(randomURL);
          const response = await fetching.json();
          const result = response.meals;
          obj.push(result);
        }
        obj.map((res) => {
          res.map((response) => {
            const condiv = document.createElement('div');
            condiv.setAttribute('id', 'cards');
            const imgdiv = document.createElement("img");
            imgdiv.setAttribute('id', 'card-img');
            const textdiv = document.createElement("div");
            textdiv.setAttribute('id', 'text')
            const h6div = document.createElement("h6");
            h6div.setAttribute('id', 'card-title');
            h6div.style.textAlign = 'center';
            const btn = document.createElement('button');
            btn.innerText = 'Add to Cart';
            btn.value = response.idMeal;
            // getting uid from session storage
            const session = sessionStorage.getItem("user-creds");
            const res = JSON.parse(session);
            const uid = res.uid;

            btn.onclick = (eve) => {
              const foodid = eve.target.attributes.value.textContent;
              push(ref(db, 'UsersRegisterList/' + uid + '/orderDetails/'), {
                foodid,
              });
              push(ref(db, 'UsersRegisterList/' + uid + '/deliveried/'), {
                foodid,
              })
                .then(() => {
                  const Toast = Swal.mixin({
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false,
                    timer: 1000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                      toast.onmouseenter = Swal.stopTimer;
                      toast.onmouseleave = Swal.resumeTimer;
                    }
                  });
                  Toast.fire({
                    icon: "success",
                    title: "Added to Cart"
                  });

                })
                .catch((err) => {
                  console.log(err.message);
                })
            };

            h6div.innerText = response.strMeal.slice(0, 10);
            imgdiv.src = response.strMealThumb;
            textdiv.append(h6div, btn)
            condiv.append(imgdiv, textdiv);
            trendingfood.appendChild(condiv);
          }
          )

        })
      }
      catch (err) {
        console.log(err);
      }
    }
    // fetchCategories();
    trendingfoods();




  </script>
</body>

</html>